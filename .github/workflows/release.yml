name: Create Release

# Workflow para criar releases automaticamente
on:
  push:
    tags:
      - 'v*.*.*'  # Trigger em tags no formato v1.0.0, v2.1.3, etc
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o da release (ex: v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Marcar como pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  create-release:
    name: Criar Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para changelog
      
      - name: Determinar versÃ£o
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ VersÃ£o: $VERSION"
      
      - name: Gerar estatÃ­sticas
        id: stats
        run: |
          # Conta scripts
          SCRIPT_COUNT=$(find .config -name "*.sh" | wc -l)
          
          # Conta pacotes
          PKG_COUNT=$(wc -l < pkglist.txt)
          AUR_COUNT=$(wc -l < aur_pkglist.txt)
          TOTAL_PKG=$((PKG_COUNT + AUR_COUNT))
          
          # Conta linhas de cÃ³digo
          TOTAL_LINES=$(find .config -name "*.sh" -o -name "*.lua" -o -name "*.fish" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          
          # Conta workflows
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" | wc -l)
          
          echo "scripts=$SCRIPT_COUNT" >> $GITHUB_OUTPUT
          echo "packages=$TOTAL_PKG" >> $GITHUB_OUTPUT
          echo "pkg_official=$PKG_COUNT" >> $GITHUB_OUTPUT
          echo "pkg_aur=$AUR_COUNT" >> $GITHUB_OUTPUT
          echo "lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
          echo "workflows=$WORKFLOW_COUNT" >> $GITHUB_OUTPUT
      
      - name: Extrair changelog da versÃ£o
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUMBER="${VERSION#v}"
          
          if [ -f CHANGELOG.md ]; then
            # Extrai a seÃ§Ã£o da versÃ£o do CHANGELOG.md
            sed -n "/## \[$VERSION_NUMBER\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
            
            # Se nÃ£o encontrou, usa changelog genÃ©rico
            if [ ! -s release_notes.md ]; then
              echo "Veja CHANGELOG.md para detalhes completos." > release_notes.md
            fi
          else
            echo "Release $VERSION" > release_notes.md
          fi
          
          echo "Release notes gerado"
      
      - name: Criar arquivo de release
        run: |
          cat > RELEASE_INFO.md << 'EOF'
          ## ðŸ“¦ InstalaÃ§Ã£o
          
          ### InstalaÃ§Ã£o RÃ¡pida
          ```bash
          git clone https://github.com/ticogafa/dotfiles.git ~/.dotfiles
          cd ~/.dotfiles
          ./install.sh  # Se vocÃª tiver um script de instalaÃ§Ã£o
          ```
          
          ### InstalaÃ§Ã£o Manual
          ```bash
          # 1. Clone o repositÃ³rio
          git clone --branch ${{ steps.version.outputs.version }} https://github.com/ticogafa/dotfiles.git ~/.dotfiles
          
          # 2. Instale os pacotes
          sudo pacman -S --needed - < pkglist.txt
          yay -S --needed - < aur_pkglist.txt
          
          # 3. Crie os symlinks (ajuste conforme necessÃ¡rio)
          stow -d ~/.dotfiles -t ~ .config
          ```
          
          ## ðŸ“Š EstatÃ­sticas desta Release
          
          - ðŸš **Scripts Shell**: ${{ steps.stats.outputs.scripts }}
          - ðŸ“¦ **Pacotes Oficiais**: ${{ steps.stats.outputs.pkg_official }}
          - ðŸ”§ **Pacotes AUR**: ${{ steps.stats.outputs.pkg_aur }}
          - ðŸ’¾ **Total de Pacotes**: ${{ steps.stats.outputs.packages }}
          - ðŸ”„ **GitHub Actions**: ${{ steps.stats.outputs.workflows }}
          - ðŸ“„ **Linhas de CÃ³digo**: ${{ steps.stats.outputs.lines }}
          
          ## ðŸ› ï¸ Tecnologias IncluÃ­das
          
          - **Window Manager**: Hyprland (Wayland)
          - **Status Bar**: Waybar
          - **Terminal**: Kitty
          - **Shell**: Fish + Starship
          - **Editor**: Neovim
          - **Launcher**: Wofi/Rofi
          - **Notifications**: SwayNC
          - **Theme Engine**: Pywal16
          - **Screenshots**: Hyprshot/Grim
          
          ## âœ… Requisitos
          
          - **SO**: Arch Linux (ou derivados)
          - **Display Server**: Wayland
          - **GPU**: AMD/NVIDIA/Intel com suporte a Vulkan
          
          ## ðŸ“ Notas Importantes
          
          - FaÃ§a backup de suas configuraÃ§Ãµes existentes antes de instalar
          - Revise os scripts antes de executÃ¡-los
          - Ajuste keybindings e configuraÃ§Ãµes conforme sua preferÃªncia
          - Alguns pacotes podem nÃ£o estar disponÃ­veis em todas as regiÃµes
          
          ## ðŸ”— Links Ãšteis
          
          - [DocumentaÃ§Ã£o Completa](https://github.com/ticogafa/dotfiles/blob/main/README.md)
          - [Changelog](https://github.com/ticogafa/dotfiles/blob/main/CHANGELOG.md)
          - [Reportar Bug](https://github.com/ticogafa/dotfiles/issues/new?template=bug_report.yml)
          - [Sugerir Feature](https://github.com/ticogafa/dotfiles/issues/new?template=feature_request.yml)
          
          ---
          
          EOF
          
          # Combina release notes com info adicional
          cat release_notes.md RELEASE_INFO.md > final_release_notes.md
      
      - name: Criar arquivos de release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Cria arquivo compactado com as configuraÃ§Ãµes
          mkdir -p release_files
          
          # Copia arquivos importantes
          cp -r .config release_files/
          cp pkglist.txt aur_pkglist.txt release_files/
          cp README.md CHANGELOG.md release_files/ 2>/dev/null || true
          cp .shellcheckrc release_files/ 2>/dev/null || true
          
          # Cria tarball
          tar -czf dotfiles-${VERSION}.tar.gz -C release_files .
          
          # Cria zip tambÃ©m
          cd release_files && zip -r ../dotfiles-${VERSION}.zip . && cd ..
          
          # Cria checksums
          sha256sum dotfiles-${VERSION}.tar.gz > dotfiles-${VERSION}.tar.gz.sha256
          sha256sum dotfiles-${VERSION}.zip > dotfiles-${VERSION}.zip.sha256
          
          echo "ðŸ“¦ Arquivos criados:"
          ls -lh dotfiles-${VERSION}*
      
      - name: Criar GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: final_release_notes.md
          draft: false
          prerelease: ${{ inputs.prerelease || false }}
          files: |
            dotfiles-${{ steps.version.outputs.version }}.tar.gz
            dotfiles-${{ steps.version.outputs.version }}.tar.gz.sha256
            dotfiles-${{ steps.version.outputs.version }}.zip
            dotfiles-${{ steps.version.outputs.version }}.zip.sha256
            pkglist.txt
            aur_pkglist.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notificar sucesso
        run: |
          echo "âœ… Release ${{ steps.version.outputs.version }} criada com sucesso!"
          echo "ðŸ”— https://github.com/ticogafa/dotfiles/releases/tag/${{ steps.version.outputs.version }}"
